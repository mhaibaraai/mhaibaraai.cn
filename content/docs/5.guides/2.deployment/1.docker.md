---
title: Docker
description: Docker å®‰è£…å’Œä½¿ç”¨æŒ‡å—
---

## å®‰è£… Docker ç¯å¢ƒ

åœ¨ Ubuntu ç³»ç»Ÿä¸Šå®‰è£… Docker å’Œ Docker Composeã€‚

::note
Docker Compose V2 å·²é›†æˆä¸º Docker CLI æ’ä»¶ï¼Œå‘½ä»¤æ ¼å¼ä¸º `docker compose`ï¼ˆç©ºæ ¼ï¼‰ï¼Œè€Œéæ—§ç‰ˆçš„ `docker-compose`ï¼ˆè¿å­—ç¬¦ï¼‰ã€‚
::

### æ–¹å¼ä¸€ï¼šå®˜æ–¹æºå®‰è£…

::code-collapse

```sh [sh]
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg

# æ·»åŠ  Docker å®˜æ–¹ GPG key
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
  sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# æ·»åŠ  Docker å®˜æ–¹ç¨³å®šæº
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•
sudo apt-get update

# å®‰è£… Docker ç›¸å…³ç»„ä»¶
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# æµ‹è¯• Docker æ˜¯å¦æ­£å¸¸
docker --version
sudo docker run hello-world
```

::

### æ–¹å¼äºŒï¼šå›½å†…é•œåƒæºå®‰è£…ï¼ˆæ¨èï¼‰

é€‚ç”¨äºå›½å†…æœåŠ¡å™¨ï¼Œä½¿ç”¨è…¾è®¯äº‘é•œåƒæºåŠ é€Ÿå®‰è£…ã€‚

::code-collapse

```sh [sh]
# 1. å¸è½½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰ï¼ŒæŠ¥é”™å¯å¿½ç•¥ï¼‰
sudo apt remove docker docker-engine docker.io containerd runc

# 2. æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦ä¾èµ–
sudo apt update
sudo apt install -y ca-certificates curl gnupg lsb-release

# 3. åˆ›å»ºå¯†é’¥ç›®å½•
sudo install -m 0755 -d /etc/apt/keyrings

# 4. æ·»åŠ  Docker GPG å¯†é’¥ï¼ˆè…¾è®¯äº‘é•œåƒï¼‰
curl -fsSL https://mirrors.cloud.tencent.com/docker-ce/linux/ubuntu/gpg | \
  sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# 5. æ·»åŠ  Docker APT ä»“åº“
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://mirrors.cloud.tencent.com/docker-ce/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 6. æ›´æ–°åŒ…ç´¢å¼•å¹¶å®‰è£…
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 7. å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# 8. éªŒè¯å®‰è£…
sudo docker --version
sudo docker compose version
sudo docker run hello-world
```

::

### é…ç½®ç”¨æˆ·æƒé™

```sh [sh]
# å°†å½“å‰ç”¨æˆ·åŠ å…¥ docker ç”¨æˆ·ç»„ï¼ˆé¿å…æ¯æ¬¡éƒ½è¦ sudoï¼‰
sudo usermod -aG docker $USER

# åº”ç”¨ç”¨æˆ·ç»„å˜æ›´ï¼ˆéœ€è¦é‡æ–°ç™»å½•æˆ–æ‰§è¡Œï¼‰
newgrp docker

# éªŒè¯æƒé™
docker ps
docker compose version
```

::warning
æ‰§è¡Œ `usermod` åéœ€è¦é€€å‡ºç»ˆç«¯å¹¶é‡æ–°ç™»å½•æ‰èƒ½ä½¿ docker ç»„æƒé™ç”Ÿæ•ˆã€‚æˆ–è€…æ‰§è¡Œ `newgrp docker` ä¸´æ—¶æ¿€æ´»ã€‚
::

### é…ç½®é•œåƒåŠ é€Ÿï¼ˆå¯é€‰ï¼‰

å›½å†…æœåŠ¡å™¨å»ºè®®é…ç½®é•œåƒåŠ é€Ÿï¼Œæå‡æ‹‰å–é€Ÿåº¦ï¼š

```sh [sh]
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://mirror.ccs.tencentyun.com"
  ]
}
EOF

# é‡å¯ Docker æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
sudo systemctl daemon-reload
sudo systemctl restart docker

# éªŒè¯é•œåƒåŠ é€Ÿé…ç½®
sudo docker info | grep -A 5 "Registry Mirrors"
```

## Nginx Docker éƒ¨ç½²

### åˆ›å»ºé¡¹ç›®ç»“æ„

```sh [sh]
mkdir -p ~/nginx/{conf,html,logs,ssl}
cd ~/nginx
```

### é…ç½®æ–‡ä»¶

::code-tree{default-value="docker-compose.yml" expand-all}

```yaml [docker-compose.yml]
services:
  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./html:/usr/share/nginx/html:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./logs:/var/log/nginx
    networks:
      - webnet

networks:
  webnet:
    driver: bridge
```

```nginx [conf/nginx.conf]
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    keepalive_timeout 65;
    
    include /etc/nginx/conf.d/*.conf;
}
```

```nginx [conf/default.conf]
server {
    listen 80;
    server_name localhost;
    
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
    }
    
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

```html [html/index.html]
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nginx Docker</title>
</head>
<body>
    <h1>Nginx è¿è¡ŒæˆåŠŸ!</h1>
    <p>é€šè¿‡ Docker éƒ¨ç½²</p>
</body>
</html>
```

::

### å¯åŠ¨æœåŠ¡

```sh [sh]
cd ~/nginx
docker compose up -d

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f nginx

# æµ‹è¯•é…ç½®
docker exec nginx nginx -t
```

è®¿é—® `http://your_server_ip` éªŒè¯éƒ¨ç½²æˆåŠŸã€‚

## Cloudflare SSL é…ç½®

### æ·»åŠ  DNS è®°å½•

åœ¨ Cloudflare æ§åˆ¶å°æ·»åŠ  DNS è®°å½•ï¼š

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com)
2. é€‰æ‹©åŸŸå â†’ DNS â†’ Records â†’ Add record
3. é…ç½®ï¼š
   - Type: `A`
   - Name: `server`ï¼ˆæˆ–å…¶ä»–å­åŸŸåï¼‰
   - IPv4 address: æœåŠ¡å™¨å…¬ç½‘ IP
   - Proxy status: ğŸŸ  Proxiedï¼ˆæ¨èï¼‰
   - TTL: Auto

### åˆ›å»º Origin è¯ä¹¦

::steps{level="3"}

### è¿›å…¥è¯ä¹¦ç®¡ç†

Cloudflare Dashboard â†’ SSL/TLS â†’ Origin Server â†’ Create Certificate

### é…ç½®è¯ä¹¦é€‰é¡¹

- Private key type: `RSA (2048)`
- Hostnames: `example.com` å’Œ `*.example.com`
- Certificate Validity: `15 years`

### ä¿å­˜è¯ä¹¦æ–‡ä»¶

å°†è¯ä¹¦å’Œç§é’¥ä¿å­˜åˆ°æœåŠ¡å™¨ `~/nginx/ssl/` ç›®å½•ï¼š

```sh [sh]
# åˆ›å»ºè¯ä¹¦æ–‡ä»¶
cat > ~/nginx/ssl/example.com.pem << 'EOF'
-----BEGIN CERTIFICATE-----
[ç²˜è´´ Origin Certificate å†…å®¹]
-----END CERTIFICATE-----
EOF

# åˆ›å»ºç§é’¥æ–‡ä»¶
cat > ~/nginx/ssl/example.com.key << 'EOF'
-----BEGIN PRIVATE KEY-----
[ç²˜è´´ Private Key å†…å®¹]
-----END PRIVATE KEY-----
EOF

# è®¾ç½®æƒé™
chmod 600 ~/nginx/ssl/*.key
chmod 644 ~/nginx/ssl/*.pem
```

::

### é…ç½® Nginx SSL

åˆ›å»º SSL ç«™ç‚¹é…ç½®ï¼š

```nginx [conf/server.example.com.conf]
server {
    listen 80;
    server_name server.example.com;
    
    # å¼ºåˆ¶ HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name server.example.com;
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/example.com.pem;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;
    
    # SSL ä¼˜åŒ–é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # ç½‘ç«™æ ¹ç›®å½•
    root /usr/share/nginx/html;
    index index.html index.htm;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # æ—¥å¿—
    access_log /var/log/nginx/server.example.com.access.log;
    error_log /var/log/nginx/server.example.com.error.log;
}
```

æ›´æ–° `docker-compose.yml` æ·»åŠ é…ç½®æŒ‚è½½ï¼š

```diff [docker-compose.yml]
services:
  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf/default.conf:/etc/nginx/conf.d/default.conf:ro
+     - ./conf/server.example.com.conf:/etc/nginx/conf.d/server.example.com.conf:ro
      - ./html:/usr/share/nginx/html:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./logs:/var/log/nginx
    networks:
      - webnet

networks:
  webnet:
    driver: bridge
```

é‡å¯æœåŠ¡ï¼š

```sh [sh]
docker compose down
docker compose up -d
docker exec nginx nginx -t
```

### è®¾ç½® SSL/TLS æ¨¡å¼

::warning
å¿…é¡»åœ¨ Cloudflare æ§åˆ¶å°è®¾ç½®æ­£ç¡®çš„ SSL/TLS æ¨¡å¼ï¼Œå¦åˆ™ä¼šå‡ºç°é”™è¯¯ã€‚
::

åœ¨ Cloudflare Dashboard â†’ SSL/TLS â†’ Overview ä¸­é€‰æ‹©ï¼š

| æ¨¡å¼ | è¯´æ˜ | æ¨è |
|-----|------|------|
| Off | ä¸åŠ å¯† | âŒ |
| Flexible | Cloudflare åˆ°æºç«™ç”¨ HTTP | âŒ ä¼šå¯¼è‡´é‡å®šå‘å¾ªç¯ |
| Full | Cloudflare åˆ°æºç«™ç”¨ HTTPS | âœ… |
| Full (strict) | éªŒè¯æºç«™è¯ä¹¦æœ‰æ•ˆæ€§ | âœ… æ¨è |

### éªŒè¯é…ç½®

```sh [sh]
# æµ‹è¯• HTTPS
curl -I https://server.example.com

# æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯
curl -vI https://server.example.com 2>&1 | grep -E "(subject|issuer|expire)"
```

## å¸¸ç”¨å‘½ä»¤

```sh [sh]
# å®¹å™¨ç®¡ç†
docker compose up -d          # å¯åŠ¨
docker compose down           # åœæ­¢
docker compose restart        # é‡å¯
docker compose ps             # æŸ¥çœ‹çŠ¶æ€
docker compose logs -f nginx  # æŸ¥çœ‹æ—¥å¿—

# Nginx æ“ä½œ
docker exec nginx nginx -t        # æµ‹è¯•é…ç½®
docker exec nginx nginx -s reload # é‡è½½é…ç½®

# è¿›å…¥å®¹å™¨
docker exec -it nginx /bin/sh
```

## å®Œæ•´é¡¹ç›®ç»“æ„

```text
~/nginx/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ conf/
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â”œâ”€â”€ default.conf
â”‚   â””â”€â”€ server.example.com.conf
â”œâ”€â”€ html/
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ ssl/
â”‚   â”œâ”€â”€ example.com.pem
â”‚   â””â”€â”€ example.com.key
â””â”€â”€ logs/
    â”œâ”€â”€ access.log
    â””â”€â”€ error.log
```
